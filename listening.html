<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TOEFL Listening Practice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --primary: #ff8c00;
        --primary-dark: #e67e00;
        --primary-light: #fff5e6;
        --dark-text: #2a2a2a;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: var(--primary-light);
        color: var(--dark-text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        padding: 60px 0 50px;
        margin-bottom: -30px;
        position: relative;
        overflow: hidden;
        z-index: 1;
      }

      header:before {
        content: "";
        position: absolute;
        bottom: -50px;
        left: 0;
        width: 100%;
        height: 10px;
        background: var(--primary-light);
        transform: skewY(-2deg);
        z-index: -1;
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        overflow: hidden;
      }

      .question-nav-container {
        width: 220px;
        position: sticky;
        top: 20px;
        height: fit-content;
        align-self: flex-start;
      }

      .question-nav {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        margin-bottom: 10px;
        padding: 15px;
        backdrop-filter: blur(5px);
      }

      .question-numbers {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
      }

      .question-number {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .question-number.answered {
        background-color: var(--primary);
        color: white;
      }

      .question-number.current {
        border: 2px solid var(--primary-dark);
        font-weight: bold;
        background-color: var(--primary-light);
        color: var(--primary-dark);
      }

      #timer-container {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        text-align: center;
        font-weight: bold;
        padding: 15px;
        margin-bottom: 10px;
        backdrop-filter: blur(5px);
      }

      #timer {
        font-size: 1.1rem;
        color: var(--primary-dark);
      }

      .listening-content {
        flex: 1;
        overflow-y: auto;
        max-height: calc(100vh - 160px);
      }

      .listening-section {
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-top: 20px;
      }

      .custom-audio-player {
        background: linear-gradient(to right, #f0f0ff, #f8f8ff);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 25px rgba(68, 36, 185, 0.1);
        margin-bottom: 25px;
        position: relative;
        border: 1px solid rgba(68, 36, 185, 0.2);
      }
      
      .audio-controls {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }
      
      .play-btn {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(68, 36, 185, 0.3);
        margin-right: 20px;
      }
      
      .play-btn:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
      }
      
      .play-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
      }
      
      .audio-info {
        display: flex;
        flex-direction: column;
      }
      
      .audio-title {
        font-weight: 600;
        font-size: 1.2rem;
        color: var(--primary-dark);
        margin-bottom: 5px;
      }
      
      .audio-status {
        font-size: 0.9rem;
        color: #666;
        font-style: italic;
      }
      
      .progress-container {
        width: 100%;
        height: 10px;
        background: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 10px;
      }
      
      .progress-bar {
        height: 100%;
        background: var(--primary);
        width: 0;
        border-radius: 5px;
        transition: width 0.1s linear;
      }
      
      .time-display {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: #666;
        margin-top: 8px;
        font-weight: 500;
      }
      
      .playback-limit-notice {
        background-color: #fff4f4;
        border-left: 4px solid #ff4d4f;
        color: #cf222e;
        font-size: 0.9rem;
        font-weight: 500;
        margin-top: 15px;
        padding: 10px 15px;
        border-radius: 4px;
      }
      
      .audio-played {
        position: relative;
      }
      
      .audio-played::after {
        content: "✓";
        position: absolute;
        top: -8px;
        right: -8px;
        width: 25px;
        height: 25px;
        background: #198754;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .question-container {
        margin-bottom: 25px;
        display: none;
        background-color: #fcfcff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .question {
        font-weight: 500;
        margin-bottom: 15px;
        color: var(--primary-dark);
      }

      .options {
        margin-left: 10px;
      }

      .options label {
        display: block;
        margin: 10px 0;
        cursor: pointer;
        padding: 10px 15px;
        border-radius: 8px;
        transition: all 0.2s;
        background-color: #f7f7ff;
        border: 1px solid #e8e8ff;
      }

      .options label:hover {
        background-color: #eeeeff;
      }

      .options input[type="radio"] {
        margin-right: 10px;
      }

      .btn {
        border-radius: 10px;
        padding: 10px 20px;
        font-weight: 500;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        border: none;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(68, 36, 185, 0.4);
      }

      .btn-warning {
        background: linear-gradient(135deg, #f8b018, #e29700);
        border: none;
        color: white;
      }

      .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(242, 153, 74, 0.4);
        color: white;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 16px;
        width: 400px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      footer {
        margin-top: auto;
        background: linear-gradient(135deg, var(--primary-dark), #2d1980);
        color: white;
        padding: 25px 0;
        position: relative;
        text-align: center;
      }

      footer:before {
        content: "";
        position: absolute;
        top: -20px;
        left: 0;
        width: 100%;
        height: 40px;
        background: var(--primary-light);
        transform: skewY(1.5deg);
        z-index: -1;
      }
    </style>
  </head>
  <body>
    <header class="container-fluid text-center py-4">
      <div class="container">
        <h1 class="mb-3">TOEFL Listening Practice Test</h1>
        <p class="lead">Listen carefully to the audio and answer the questions.</p>
      </div>
    </header>

    <div class="container my-5">
      <div class="row">
        <div class="col-md-3">
          <div class="question-nav-container">
            <div class="question-nav glass-card mb-3">
              <h4 class="text-center mb-3">
                <i class="fas fa-list-ul me-2"></i> Questions
              </h4>
              <div class="question-numbers" id="questionNumbers"></div>
            </div>
            <div id="timer-container" class="glass-card mb-3">
              <div id="timer">
                <i class="fas fa-clock me-2"></i> Time Remaining: 30:00
              </div>
            </div>
            <div class="glass-card p-3">
              <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                <i class="fas fa-paper-plane me-2"></i> Submit Answers
              </button>
            </div>
          </div>
        </div>

        <div class="col-md-9">
          <div class="listening-section glass-card">
            <div class="passage mb-4">
              <h3><i class="fas fa-headphones-alt me-2"></i> SECTION I: LISTENING COMPREHENSION</h3>
              <p>
                In this section of the test, you will have the chance to show how well you understand spoken English. There are four parts to this section, with special directions for each part.
              </p>
              <p>
                <strong><i class="fas fa-exclamation-circle me-2"></i> Important:</strong> Each audio can only be played once to simulate real exam conditions. Listen carefully before answering the questions.
              </p>
            </div>

            <div class="custom-audio-player" id="customAudioPlayer">
              <div class="audio-controls">
                <button class="play-btn" id="playBtn">
                  <i class="fas fa-play" id="playIcon"></i>
                </button>
                <div class="audio-info">
                  <p class="audio-title" id="currentAudioTitle">Conversation 1</p>
                  <span class="audio-status" id="audioStatus">Ready to play</span>
                </div>
              </div>
              
              <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
              </div>
              
              <div class="time-display">
                <span id="currentTime">0:00</span>
                <span id="durationTime">0:00</span>
              </div>
              
              <div class="playback-limit-notice">
                <i class="fas fa-info-circle me-2"></i> Note: Each audio recording can only be played once to simulate exam conditions.
              </div>
              
              <!-- Hidden native audio element -->
              <audio id="mainAudio" style="display:none">
                <source src="src/assets/sound/q1.wav" type="audio/wav">
                Your browser does not support the audio element.
              </audio>
            </div>

            <form id="listening-quiz">
              <!-- Questions will be dynamically created by script -->
              <div class="navigation-buttons d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary" id="prevBtn" disabled>
                  <i class="fas fa-arrow-left me-2"></i> Previous
                </button>
                <button type="button" class="btn btn-warning" id="nextBtn">
                  Next <i class="fas fa-arrow-right ms-2"></i>
                </button>
                <button type="button" class="btn btn-warning" id="submitPageBtn" style="display: none">
                  Submit All <i class="fas fa-check ms-2"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <h4>
          <i class="fas fa-exclamation-triangle text-warning me-2"></i> Confirm Submission
        </h4>
        <p>You won't be able to change your answers after submitting.</p>
        <div class="d-flex justify-content-center gap-3 mt-4">
          <button id="confirmYes" class="btn btn-success">Yes, Submit</button>
          <button id="confirmNo" class="btn btn-danger">Cancel</button>
        </div>
      </div>
    </div>

    <footer class="container-fluid py-3">
      <div class="container">
        <p class="small mb-0">© 2025 TOEFL Tester | Practice Listening Skills</p>
      </div>
    </footer>

    <script>
      // Data pertanyaan - tetap sama seperti di listening.html asli
      const questionsPerPage = 5;
      const questions = [
        {
          audio: "src/assets/sound/q1.wav",
          title: "Conversation 1",
          question: "1. What is the main topic of the conversation?",
          options: [
            "A) A class assignment",
            "B) A student organization",
            "C) A campus event",
            "D) A research project"
          ],
          correctAnswer: "c"
        },
        {
          audio: "src/assets/sound/q1.wav",
          title: "Conversation 1",
          question: "2. What problem does the woman mention?",
          options: [
            "A) Lack of funding",
            "B) Not enough volunteers",
            "C) Scheduling conflicts",
            "D) Limited space"
          ],
          correctAnswer: "b"
        },
        {
          audio: "src/assets/sound/q1.wav",
          title: "Conversation 1",
          question: "3. What does the man suggest doing?",
          options: [
            "A) Postponing the event",
            "B) Finding additional sponsors",
            "C) Recruiting more volunteers",
            "D) Changing the venue"
          ],
          correctAnswer: "c"
        },
        {
          audio: "src/assets/sound/q2.wav",
          title: "Lecture: Biology",
          question: "4. What is the main topic of the lecture?",
          options: [
            "A) Animal adaptations",
            "B) Environmental change",
            "C) Evolution theory",
            "D) Marine ecosystems"
          ],
          correctAnswer: "a"
        },
        {
          audio: "src/assets/sound/q2.wav",
          title: "Lecture: Biology",
          question: "5. According to the professor, why do animals develop adaptations?",
          options: [
            "A) To compete with other species",
            "B) To survive in their environment",
            "C) To attract mates",
            "D) To improve their hunting abilities"
          ],
          correctAnswer: "b"
        },
        {
          audio: "src/assets/sound/q2.wav",
          title: "Lecture: Biology",
          question: "6. What example does the professor give of a physical adaptation?",
          options: [
            "A) Migration patterns",
            "B) Hibernation",
            "C) Camouflage",
            "D) Hunting strategies"
          ],
          correctAnswer: "c"
        },
        {
          audio: "src/assets/sound/q3.wav",
          title: "Conversation: Academic Advising",
          question: "7. Why does the student visit the advisor?",
          options: [
            "A) To discuss course selection",
            "B) To request a letter of recommendation",
            "C) To inquire about graduation requirements",
            "D) To change majors"
          ],
          correctAnswer: "a"
        },
        {
          audio: "src/assets/sound/q3.wav",
          title: "Conversation: Academic Advising",
          question: "8. What concern does the advisor express about the student's schedule?",
          options: [
            "A) Too many advanced courses",
            "B) Scheduling conflicts",
            "C) Prerequisites not completed",
            "D) Too many credit hours"
          ],
          correctAnswer: "d"
        },
        {
          audio: "src/assets/sound/q3.wav",
          title: "Conversation: Academic Advising",
          question: "9. What solution does the advisor suggest?",
          options: [
            "A) Taking summer classes",
            "B) Dropping a course",
            "C) Getting permission from the department",
            "D) Postponing graduation"
          ],
          correctAnswer: "b"
        },
        {
          audio: "src/assets/sound/q4.wav",
          title: "Lecture: American History",
          question: "10. What period of history does the lecture primarily focus on?",
          options: [
            "A) The Colonial Era",
            "B) The Civil War",
            "C) The Industrial Revolution",
            "D) World War II"
          ],
          correctAnswer: "c"
        }
      ];

      // Audio playback tracking
      const playedAudios = new Set();

      // Timer
      let timeLeft = 30 * 60; // 30 minutes in seconds
      const timerDisplay = document.getElementById("timer");

      function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.innerHTML = `<i class="fas fa-clock me-2"></i> Time Remaining: ${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          alert("Time's up!");
          submitQuiz();
        }
        timeLeft--;
      }

      // Check if coming from another page
      window.addEventListener("beforeunload", function() {
        localStorage.setItem("listeningTimeLeft", timeLeft);
        // Also store which audios have been played
        localStorage.setItem("playedAudios", JSON.stringify(Array.from(playedAudios)));
      });

      const timerInterval = setInterval(updateTimer, 1000);

      // Enhanced Audio management
      let currentAudioGroup = "";
      const mainAudio = document.getElementById("mainAudio");
      const playBtn = document.getElementById("playBtn");
      const playIcon = document.getElementById("playIcon");
      const progressBar = document.getElementById("progressBar");
      const currentTime = document.getElementById("currentTime");
      const durationTime = document.getElementById("durationTime");
      const audioStatus = document.getElementById("audioStatus");
      const audioTitle = document.getElementById("currentAudioTitle");

      // Load played audios from localStorage if available
      try {
        const storedPlayedAudios = JSON.parse(localStorage.getItem("playedAudios"));
        if (Array.isArray(storedPlayedAudios)) {
          storedPlayedAudios.forEach(audio => playedAudios.add(audio));
        }
      } catch (e) {
        console.error("Error loading played audios:", e);
      }

      // Format time from seconds to MM:SS
      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
      }

      // Audio event listeners
      mainAudio.addEventListener('timeupdate', () => {
        const duration = mainAudio.duration;
        const currentTimeValue = mainAudio.currentTime;
        const percentage = (currentTimeValue / duration) * 100;
        
        progressBar.style.width = `${percentage}%`;
        currentTime.textContent = formatTime(currentTimeValue);
        
        // Update status text based on progress
        if (percentage > 0 && percentage < 100) {
          audioStatus.textContent = "Playing...";
        }
      });

      mainAudio.addEventListener('loadedmetadata', () => {
        durationTime.textContent = formatTime(mainAudio.duration);
        audioStatus.textContent = "Ready to play";
      });

      mainAudio.addEventListener('ended', () => {
        playIcon.classList.remove('fa-pause');
        playIcon.classList.add('fa-play');
        progressBar.style.width = '100%';
        audioStatus.textContent = "Playback complete";
        
        // Mark this audio as played and disable the button
        playedAudios.add(currentAudioGroup);
        playBtn.disabled = true;
        playBtn.classList.add('audio-played');
      });

      playBtn.addEventListener('click', () => {
        // If the audio has already been played, don't allow playback
        if (playedAudios.has(currentAudioGroup)) {
          audioStatus.textContent = "Already played (limited to once)";
          return;
        }
        
        if (mainAudio.paused) {
          mainAudio.play();
          playIcon.classList.remove('fa-play');
          playIcon.classList.add('fa-pause');
          audioStatus.textContent = "Playing...";
        } else {
          mainAudio.pause();
          playIcon.classList.remove('fa-pause');
          playIcon.classList.add('fa-play');
          audioStatus.textContent = "Paused";
        }
      });

      function updateAudioSource(audioFile, title) {
        if (currentAudioGroup !== audioFile) {
          mainAudio.src = audioFile;
          mainAudio.load();
          audioTitle.textContent = title;
          currentAudioGroup = audioFile;
          
          // Reset progress bar and status
          progressBar.style.width = '0%';
          currentTime.textContent = '0:00';
          durationTime.textContent = '0:00';
          
          // Check if this audio has already been played
          if (playedAudios.has(audioFile)) {
            playBtn.disabled = true;
            playBtn.classList.add('audio-played');
            audioStatus.textContent = "Already played (limited to once)";
          } else {
            playBtn.disabled = false;
            playBtn.classList.remove('audio-played');
            playIcon.classList.remove('fa-pause');
            playIcon.classList.add('fa-play');
            audioStatus.textContent = "Ready to play";
          }
        }
      }

      // Fungsi untuk membuat elemen pertanyaan
      function createQuestionElements() {
        const quizForm = document.getElementById("listening-quiz");
        const navigationButtons = quizForm.querySelector(".navigation-buttons");

        // Hapus semua pertanyaan yang ada (jika ada)
        const existingQuestions = quizForm.querySelectorAll(
          ".question-container"
        );
        existingQuestions.forEach((q) => q.remove());

        questions.forEach((q, index) => {
          const questionNum = index + 1;
          const pageNum = Math.ceil(questionNum / questionsPerPage);

          const questionContainer = document.createElement("div");
          questionContainer.className = "question-container";
          questionContainer.dataset.page = pageNum;
          questionContainer.dataset.question = questionNum;
          questionContainer.dataset.audio = q.audio;
          questionContainer.dataset.title = q.title;
          questionContainer.style.display = "none";

          const questionDiv = document.createElement("div");
          questionDiv.className = "question";
          questionDiv.innerHTML = `<i class="fas fa-question-circle me-2"></i> ${q.question}`;

          const optionsDiv = document.createElement("div");
          optionsDiv.className = "options";

          q.options.forEach((option, optIndex) => {
            const label = document.createElement("label");
            const input = document.createElement("input");
            input.type = "radio";
            input.name = `q${questionNum}`;
            input.value = String.fromCharCode(97 + optIndex); // a, b, c, d

            label.appendChild(input);
            label.appendChild(document.createTextNode(` ${option}`));
            optionsDiv.appendChild(label);
          });

          questionContainer.appendChild(questionDiv);
          questionContainer.appendChild(optionsDiv);
          quizForm.insertBefore(questionContainer, navigationButtons);
        });

        // Tampilkan halaman pertama
        showPage(1);
      }

      // Initialize question numbers
      const questionNumbersContainer =
        document.getElementById("questionNumbers");
      const totalQuestions = questions.length;

      function initializeQuestionNumbers() {
        questionNumbersContainer.innerHTML = "";

        for (let i = 1; i <= totalQuestions; i++) {
          const numberBtn = document.createElement("div");
          numberBtn.className = "question-number";
          numberBtn.textContent = i;
          numberBtn.dataset.question = i;
          numberBtn.addEventListener("click", () => {
            const pageNum = Math.ceil(i / questionsPerPage);
            showPage(pageNum);
            // Scroll to the specific question
            const questionElement = document.querySelector(
              `.question-container[data-question="${i}"]`
            );
            if (questionElement) {
              questionElement.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
              
              // Update audio source if needed
              updateAudioSource(
                questionElement.dataset.audio,
                questionElement.dataset.title
              );
            }
          });
          questionNumbersContainer.appendChild(numberBtn);
        }
      }

      // Track answered questions
      const answeredQuestions = new Set();

      // Add event listeners to all radio buttons
      function setupRadioButtonListeners() {
        document.querySelectorAll('input[type="radio"]').forEach((radio) => {
          radio.addEventListener("change", function () {
            const questionNum = this.name.substring(1);
            answeredQuestions.add(parseInt(questionNum));
            updateQuestionNumbers();

            // Simpan jawaban ke localStorage
            const userAnswers =
              JSON.parse(localStorage.getItem("listeningAnswers")) || {};
            userAnswers[`q${questionNum}`] = this.value;
            localStorage.setItem("listeningAnswers", JSON.stringify(userAnswers));
          });
        });
      }

      function updateQuestionNumbers() {
        document.querySelectorAll(".question-number").forEach((el) => {
          const questionNum = parseInt(el.dataset.question);
          el.classList.toggle("answered", answeredQuestions.has(questionNum));
          // Highlight current page questions
          const currentPageQuestions = Array.from(
            { length: questionsPerPage },
            (_, i) => (currentPage - 1) * questionsPerPage + i + 1
          );
          el.classList.toggle(
            "current",
            currentPageQuestions.includes(questionNum)
          );
        });
      }

      // Pagination logic
      let currentPage = 1;
      const totalPages = Math.ceil(totalQuestions / questionsPerPage);

      function showPage(pageNumber) {
        currentPage = pageNumber;
        const allQuestions = document.querySelectorAll(".question-container");
        allQuestions.forEach((q) => (q.style.display = "none"));

        // Show all questions for current page
        const pageQuestions = document.querySelectorAll(
          `.question-container[data-page="${pageNumber}"]`
        );
        pageQuestions.forEach((q) => (q.style.display = "block"));
        
        // Update audio source based on first question of the page
        if (pageQuestions.length > 0) {
          const firstQuestion = pageQuestions[0];
          updateAudioSource(
            firstQuestion.dataset.audio,
            firstQuestion.dataset.title
          );
        }

        updateQuestionNumbers();
        updateNavigationButtons();

        // Scroll to top of questions
        const firstQuestion = document.querySelector(
          `.question-container[data-page="${pageNumber}"][data-question="${
            (pageNumber - 1) * questionsPerPage + 1
          }"]`
        );
        if (firstQuestion) {
          firstQuestion.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      }

      function updateNavigationButtons() {
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const submitPageBtn = document.getElementById("submitPageBtn");

        // Update Previous button
        prevBtn.disabled = currentPage === 1;

        // Update Next/Submit buttons
        if (currentPage === totalPages) {
          nextBtn.style.display = "none";
          submitPageBtn.style.display = "inline-block";
        } else {
          nextBtn.style.display = "inline-block";
          submitPageBtn.style.display = "none";
        }
      }

      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentPage > 1) {
          showPage(currentPage - 1);
        }
      });

      document.getElementById("nextBtn").addEventListener("click", () => {
        if (currentPage < totalPages) {
          showPage(currentPage + 1);
        }
      });

      document.getElementById("submitPageBtn").addEventListener("click", () => {
        document.getElementById("confirmModal").style.display = "flex";
      });

      // Initialize
      createQuestionElements();
      initializeQuestionNumbers();
      setupRadioButtonListeners();
      updateNavigationButtons();

      // Modal Confirmation
      document
        .getElementById("submitBtn")
        .addEventListener("click", function (e) {
          e.preventDefault();
          document.getElementById("confirmModal").style.display = "flex";
        });

      document
        .getElementById("confirmYes")
        .addEventListener("click", function () {
          submitQuiz();
        });

      document
        .getElementById("confirmNo")
        .addEventListener("click", function () {
          document.getElementById("confirmModal").style.display = "none";
        });

      // Submit Logic
      function submitQuiz() {
        document.getElementById("confirmModal").style.display = "none";
        clearInterval(timerInterval);

        let score = 0;
        const feedback = [];
        const questionDetails = {};
        const userAnswers = {};
        const categories = {
          conversation: { correct: 0, total: 6 },
          lecture: { correct: 0, total: 4 }
        };

        // Definisi kategori soal
        const questionCategories = {
          q1: "conversation",
          q2: "conversation",
          q3: "conversation",
          q4: "lecture",
          q5: "lecture",
          q6: "lecture",
          q7: "conversation",
          q8: "conversation",
          q9: "conversation",
          q10: "lecture"
        };

        questions.forEach((q, index) => {
          const questionNum = index + 1;
          const questionKey = `q${questionNum}`;
          const selected = document.querySelector(
            `input[name="q${questionNum}"]:checked`
          );
          const userAnswer = selected ? selected.value : null;

          userAnswers[questionKey] = userAnswer;
          const isCorrect = selected && selected.value === q.correctAnswer;

          if (isCorrect) {
            score++;
            feedback.push({ question: questionNum, result: "✓" });
          } else {
            feedback.push({
              question: questionNum,
              result: "✗",
              correct: q.correctAnswer.toUpperCase(),
            });
          }

          // Update kategori
          const category = questionCategories[questionKey];
          if (category) {
            if (isCorrect) categories[category].correct += 1;
          }

          questionDetails[questionKey] = {
            yourAnswer: userAnswer ? userAnswer.toUpperCase() : "-",
            correctAnswer: q.correctAnswer.toUpperCase(),
            result: isCorrect ? "✓" : "✗",
          };
        });

        localStorage.setItem("listeningScore", score);
        localStorage.setItem("listeningTotalQuestions", questions.length);
        localStorage.setItem("listeningAnswers", JSON.stringify(userAnswers));
        localStorage.setItem(
          "listeningQuestionDetails",
          JSON.stringify(questionDetails)
        );
        localStorage.setItem("listeningCategories", JSON.stringify(categories));
        
        // Save that listening test is complete
        localStorage.setItem("listeningComplete", "true");
        
        // Redirect to reading.html
        window.location.href = "reading.html";
      }

      document
        .getElementById("listening-quiz")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          submitQuiz();
        });

      // Disable right-click
      document.addEventListener("contextmenu", (e) => {
        e.preventDefault();
      });
    </script>
  </body>
</html>